"""
–û—Å–Ω–æ–≤–Ω—ã–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã –±–æ—Ç–∞.
"""
from asgiref.sync import sync_to_async
from pyrogram import Client, filters
from django.urls import reverse

from tag_bot.settings import MY_LOGGER, BOT_TOKEN, BASE_HOST
from tgbot.keyboards.bot_keyboards import form_webapp_kbrd
from tgbot.tests import update_or_create_bot_user
from webapp.models import BotUser


@Client.on_message(filters.command(['start', 'menu']))
async def start_handler(_, update):
    """
    –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞. –û—Ç–¥–∞—ë—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    """
    MY_LOGGER.info(f'–°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è —é–∑–µ—Ä–∞ {update.from_user.id!r}')

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —é–∑–µ—Ä–∞ –≤ –ë–î
    await update_or_create_bot_user(update)
    button_data = (
        ('üí≤ –ú–æ–π –±–∞–ª–∞–Ω—Å', f"{BASE_HOST}{reverse(viewname='webapp:balance')}?token={BOT_TOKEN}"),
    )
    await update.reply_text(
        text=f'üëã –ü—Ä–∏–≤–µ—Ç!\n\n–≠—Ç–æ –±–æ—Ç —Ç–µ–≥–≥–µ—Ä. –û–Ω —Ç–µ–≥–∞–µ—Ç –ª—é–¥–µ–π –≤ –í–∞—à–∏—Ö –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.',
        reply_markup=await form_webapp_kbrd(button_data)
    )